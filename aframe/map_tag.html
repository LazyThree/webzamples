<!--
    This is super duper hacky. I grab the <area> based on an idea from:
    https://stackoverflow.com/questions/22428484/get-element-from-point-when-you-have-overlapping-elements
-->
<!DOCTYPE html>
<html>
  <head>
    <title>a-frame meets `map`</title>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script
      src="https://kit.fontawesome.com/c9500776a0.js"
      crossorigin="anonymous"
    ></script>
    <script src="misc/codeBtn.js"></script>
    <!-- place the scene above the images, which are not displayed by default-->
    <style>
      a-scene {
        display: block;
        z-index: 1;
      }
      .mapimage {
        display: none;
        position: fixed;
        top: 0px;
        left: 0px;
        z-index: 0;
      }
      area {
        pointer-events: inherit;
      }
    </style>
  </head>
  <body>
    <script>
      function inside(point, vs) {
        // ray-casting algorithm based on
        // https://wrf.ecse.rpi.edu/Research/Short_Notes/pnpoly.html/pnpoly.html

        var x = point[0],
          y = point[1];

        var inside = false;
        for (var i = 0, j = vs.length - 1; i < vs.length; j = i++) {
          var xi = vs[i][0],
            yi = vs[i][1];
          var xj = vs[j][0],
            yj = vs[j][1];

          var intersect =
            yi > y != yj > y && x < ((xj - xi) * (y - yi)) / (yj - yi) + xi;
          if (intersect) inside = !inside;
        }

        return inside;
      }

      AFRAME.registerComponent("fakeareas", {
        schema: {
          map: { value: "" },
          imageWidth: {value: 0},
          imageHeight: {value: 0}
        },
        init: function() {
          this.polygons = [];
          let imageWidth;
          let imageHeight;
          
          let mesh = this.el.getObject3D("mesh");
          var idx = setInterval(e => {
            if (!mesh.material.map) return;
            clearInterval(idx);
            let image = mesh.material.map.image;

            // set the w / h if not provided
            imageWidth = this.data.imageWidth ? this.data.imageWidth : image.width
            imageHeight = this.data.imageHeight ? this.data.imageHeight : image.height
            
            // CREATE areas
            var mapEl = document.querySelector(this.data.map);
            var areas = mapEl.children;

            for (let area of areas) {
              var shape = area.getAttribute("shape");
              var coords = area
                .getAttribute("coords")
                .trim()
                .split(",")
                .map(x => parseInt(x));

              let poly = [];
              if (shape === "rect") {
                poly = [[coords[0], coords[1]], [coords[0], coords[3]], [coords[2], coords[3]], [coords[2], coords[1]]]
              } else {
                for (let i = 0; i < coords.length; i += 2) {
                  poly.push([coords[i], parseInt(coords[i + 1])]);
                }
              }
                this.polygons.push({
                  area: poly,
                  action: area.getAttribute("href")
                });
            }
            
            this.el.addEventListener("click", evt => {
              var uvPoint = evt.detail.intersection.uv;
              var x = uvPoint.x * imageWidth
              var y = imageHeight - uvPoint.y * imageHeight

              for (var i = 0; i < this.polygons.length; i++) {    
                if (inside([x,y], this.polygons[i].area)) {
                 window.location = this.polygons[i].action
                }
              }
            })
          }, 50);
        }
      });
    </script>
    <!-- A simple and basic scene -->
    <a-scene
      background="color: white"
      cursor="rayOrigin: mouse"
      raycaster="objects: .clickable"
    >
      <a-assets>
        <img
          id="showcase"
          src="https://rawcdn.githack.com/gftruj/webzamples/ee4ca5f48132b7fde88f941d66bc2a78dc09f7e2/aframe/assets/images/aframe-showcase.jpg"
        />
        <img
          id="pano"
          src="https://rawcdn.githack.com/gftruj/webzamples/ee4ca5f48132b7fde88f941d66bc2a78dc09f7e2/aframe/assets/images/pano.jpg"
        />
      </a-assets>
      <a-text
        position="-2 3 -3"
        color="black"
        value="Press any showcase tile,\n and find the blue trail marker"
      ></a-text>
      <!-- SHOWCASE TEXT + PLANE -->
      <a-text
        id="showcase-text"
        position="-0.75 1.75 -2"
        value=""
        color="black"
      ></a-text>
      <a-plane
        class="clickable"
        position="-0.25 1 -2"
        rotation="0 0 0"
        width="2"
        material="src: #showcase"
        fakeareas="map: #showcase-map; imageWidth: 512; imageHeight: 256"
      ></a-plane>

      <!-- CYLINDER -->
      <a-cylinder
        class="clickable"
        scale="-1 1 1"
        material="src: #pano; side: back"
        height="5"
        radius="5"
        open-ended="true"
        theta-start="45"
        theta-length="270"
        fakeareas="map: #pano-map"
      ></a-cylinder>
    </a-scene>

    <!-- showcase map -->
    <map id="showcase-map" name="showcase-map">
      <area
        shape="poly"
        coords="0, 0, 0, 128, 170, 128, 170, 0"
        alt="superframe"
        href="javascript:tilePressed('superframe');console.log('superframe')"
      />
      <area
        shape="poly"
        coords="173,0, 173, 128, 344,128, 344, 0"
        alt="superframe"
        href="javascript:tilePressed('a-painter'); console.log('a-painter')"
      />
      <area
        shape="rect"
        coords="347, 0, 509, 347"
        alt="superframe"
        href="javascript:tilePressed('supermedium')"
      />

      <area
        shape="rect"
        coords="0,130,168,255"
        alt="superframe"
        href="javascript:tilePressed('a-blast')"
      />
      <area
        shape="rect"
        coords="173,130,344,255"
        alt="superframe"
        href="javascript:tilePressed('a-saturday-night')"
      />
      <area
        shape="rect"
        coords="347,130,509,255"
        alt="superframe"
        href="javascript:tilePressed('musical-forest')"
      />
    </map>

    <!-- pano map -->
    <map id="pano-map" name="pano-map">
      <area
        shape="rect"
        coords="280, 150, 315, 180 "
        alt="tag"
        href="https://www.google.com/maps/place/Polana+pod+Wo%C5%82oszynem/@49.2487508,20.0905469,15.5z/data=!4m8!1m2!3m1!2sPolana+pod+Wo%C5%82oszynem!3m4!1s0x4715f4d4e66bd933:0x1a268f1a1b1edb82!8m2!3d49.2458976!4d20.0825411"
      />
    </map>
  </body>

  <script>
    function tilePressed(tile) {
      document.querySelector("#showcase-text").setAttribute("value", tile);
    }

    // create the "show code" button
    setCodeBtnUrl("aframe/map_tag.html");
  </script>
</html>
